## 调参与最佳实践（TUNING）

本指南提供在不同账户规模与市场环境下的阈值建议、排序权重和运行优化建议。

### 1. 账户规模与硬过滤

- 小账户（< 100万）
  - `liquidity_rmb_min`: 5e7（5,000万）
  - `min_price`: 5.0
  - `atrp_min/max`: 0.03 / 0.15
  - `near_high_lookback`: 60；`near_high_max`: 0.05
- 中账户（100万 ~ 1,000万）
  - `liquidity_rmb_min`: 1e8（1亿）
  - 其余同上
- 大账户（> 1,000万）
  - `liquidity_rmb_min`: 2e8（2亿）或更高
  - 可适当放宽 `atrp_max` 至 0.18，兼顾执行与波动

备注：若纳入科创/北交，建议 `liquidity_rmb_min >= 1e8`。

### 2. 指数篮子与环境闸门

- 动量/中小盘：`[000985.CSI, 000852.SH, 399006.SZ]`
- 白马/机构：`[000985.CSI, 000300.SH, 000905.SH]`
- 闸门规则：3 指数中≥2 指数满足（周线 close>ma20w 且 ma20w 上行）则“允许进攻”，否则“谨慎/防守”。
- 无指数权限时：程序自动跳过闸门，不影响计算。

### 3. 排序权重（Score）

默认（均衡动量+执行）：
- `rs60: 0.4`（中期动量）
- `near_high: 0.3`（近高位度，越接近新高越好）
- `liquidity: 0.2`（20 日均额，偏执行）
- `atrp: 0.1`（波动中性，靠近中位更高分）

可选方案：
- 激进动量：`rs60 0.5` / `near_high 0.35` / `liquidity 0.1` / `atrp 0.05`
- 稳健执行：`rs60 0.3` / `near_high 0.25` / `liquidity 0.35` / `atrp 0.1`

### 4. 通过率与样本量不足

- 放宽 `near_high_max` 至 `0.08`
- 暂时移除 `rsi14_min`（设为 `null` 或在配置注释掉）
- 扩大 Universe（指数篮子更宽或全市场）

### 5. 运行效率与配额

- `sleep_per_call`：若出现“每分钟最多访问X次”，增大至 `1.0~1.5` 秒
- 优先选择“按 trade_date 全市场”做日更（后续版本可启用批量接口）
- 利用缓存：首次全量后，日更只拉增量；运行中断可随时重启继续
- `--offline`：仅用本地缓存快速产出结果，不触发网络请求

### 6. 盘前 Focus 模板

- `focus_max`: 20~30
- 当日量能阈值：`amount_threshold = 1.8 × amount_ma20`
- 枢轴草案：近 `near_high_lookback` 日高（默认 60）
- 形态人工补充：三角、旗形、EMA 回踩；14:00 后“三确认”执行

### 7. 指数相对强度（增强项）

- 现用自身 `ret20/ret60` 代替相对强度（RS）。
- 增强：用“个股收益 − 基准指数收益”替代，基准可选 `000985.CSI`。

### 8. 收敛/形态评分（增强项）

- 20 日高低振幅比 `(HHV20 − LLV20)/close`，取倒数作为“压缩度”。
- 与 `atrp` 分位综合成“收敛分数”，参与排序或二次筛选。

### 9. 情绪面板（增强项）

- `sentiment_stage` 接入你的面板服务：`转强/主升/震荡/退潮/冰点`。
- 当 `S ∈ {退潮, 冰点}` 时，自动只导出回踩型候选或清空 focus。

### 10. 常见问题排查

- 样本过少：放宽阈值或扩大 Universe；确认 `cache/daily` 是否逐步增加
- 接口报错/频控：调大 `sleep_per_call`，或改用 `--offline` 输出
- 指数成分为空：若 TuShare 与东财均不可用，自动保留全市场；可手动在配置中直接限定 ts_code 列表（需要你定制）

### 11. 推荐日更命令
```bash
# 在线增量更新（过去一年即可）
python3 main.py --start 20240101 --export ./out
# 快速复算（不访问网络）
python3 main.py --start 20240101 --export ./out --offline
```

